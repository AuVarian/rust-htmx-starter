<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Aurune</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 1) Set theme before paint (no flash) -->
    <script>
      (() => {
        const stored = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        const isDark = stored ? stored === "dark" : prefersDark;
        document.documentElement.classList.toggle("dark", isDark);
      })();
    </script>
    <!-- htmx -->
    <script src="/static/js/htmx.min.js"></script>
    <!-- tailwind build -->
    <link rel="stylesheet" href="/static/css/app.css" />
  </head>

  <body class="bg-white text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">
    <header class="border-b bg-neutral-50 dark:bg-neutral-800">
      <nav class="bg-white dark:bg-neutral-900">
        <div class="mx-auto max-w-screen p-5 flex items-center gap-4">
          <!-- LEFT: Logo + Title -->
          <a href="/" class="flex items-center gap-2">
            <img id="logo-img" src="/static/img/openvpn-light.svg" alt="Aurune" width="24" height="24" class="h-6 w-6" />
            <span class="text-2xl font-semibold">FEVA</span>
          </a>







          <!-- Separator -->
          <div class="h-6 w-px bg-neutral-200 dark:bg-neutral-700"></div>

          <!-- Tabs bar (left-aligned, Flowbite style) -->
          <div id="tabs"
              class="flex-1 min-w-0 text-sm font-medium text-neutral-500 dark:text-neutral-400 overflow-y-hidden overflow-x-hidden">
            <ul class="flex flex-wrap -mb-px">
              <li class="me-2">
                <a hx-get="/tabs/overview" hx-target="#main" hx-swap="innerHTML" hx-push-url="true"
                   class="inline-block p-4 border-b-2 border-transparent rounded-t-lg
                          hover:text-neutral-600 hover:border-neutral-300 dark:hover:text-neutral-300">
                  Overview
                </a>
              </li>
              <li class="me-2">
                <a hx-get="/tabs/details" hx-target="#main" hx-swap="innerHTML" hx-push-url="true"
                   aria-current="page"
                   class="inline-block p-4 text-blue-600 border-b-2 border-blue-600 rounded-t-lg active
                          dark:text-blue-500 dark:border-blue-500">
                  Details
                </a>
              </li>
              <li class="me-2">
                <a hx-get="/tabs/vlans" hx-target="#main" hx-swap="innerHTML" hx-push-url="true"
                   class="inline-block p-4 border-b-2 border-transparent rounded-t-lg
                          hover:text-neutral-600 hover:border-neutral-300 dark:hover:text-neutral-300">
                  Vlans
                </a>
              </li>
              <li class="me-2">
                <a hx-get="/tabs/settings" hx-target="#main" hx-swap="innerHTML" hx-push-url="true"
                   class="inline-block p-4 border-b-2 border-transparent rounded-t-lg
                          hover:text-neutral-600 hover:border-neutral-300 dark:hover:text-neutral-300">
                  Settings
                </a>
              </li>
              <li>
                <a class="inline-block p-4 text-neutral-400 rounded-t-lg cursor-not-allowed dark:text-neutral-500">
                  Disabled
                </a>
              </li>
            </ul>
          </div>

          <!-- RIGHT: push utilities to the far right -->
          <div class="ml-auto flex items-center gap-3">
            <!-- Login popover -->
            <div class="relative">
              <button
                id="login-toggle"
                type="button"
                aria-haspopup="dialog"
                aria-expanded="false"
                aria-controls="login-popover"
                class="block text-white bg-blue-600 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center
                       dark:bg-blue-700 dark:hover:bg-blue-800">
                Login
              </button>

              <!-- Anchored popover (hidden by default) -->
              <div
                id="login-popover"
                role="dialog"
                aria-modal="false"
                class="hidden absolute top-full right-0 mt-2 z-50 w-80 max-w-[90vw]
                       rounded-lg border border-neutral-200 bg-white shadow-lg
                       dark:bg-neutral-800 dark:border-neutral-700"
              >
                <div class="p-4">
                  <div class="flex items-center justify-between mb-3">
                    <h3 class="text-lg font-semibold text-neutral-900 dark:text-white">Login</h3>
                    <button
                      type="button"
                      class="text-neutral-400 hover:text-neutral-700 dark:hover:text-neutral-200"
                      id="login-close"
                      aria-label="Close">
                      ✕
                    </button>
                  </div>

                  <form class="space-y-4" action="#" onsubmit="event.preventDefault()">
                    <div>
                      <label for="userid" class="block mb-1 text-sm font-medium">Username</label>
                      <input
                        type="text" id="userid" name="userid" autocomplete="username"
                        class="w-full rounded-lg border border-neutral-300 px-3 py-2 text-sm
                               focus:ring-blue-500 focus:border-blue-500
                               dark:bg-neutral-700 dark:border-neutral-600 dark:placeholder-neutral-400 dark:text-white"
                        required />
                    </div>
                    <div>
                      <label for="password" class="block mb-1 text-sm font-medium">Password</label>
                      <input
                        type="password" id="password" name="password" autocomplete="current-password"
                        class="w-full rounded-lg border border-neutral-300 px-3 py-2 text-sm
                               focus:ring-blue-500 focus:border-blue-500
                               dark:bg-neutral-700 dark:border-neutral-600 dark:placeholder-neutral-400 dark:text-white"
                        required />
                    </div>
                    <button
                      type="submit"
                      class="w-full text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5
                             dark:bg-blue-700 dark:hover:bg-blue-800">
                      Login
                    </button>
                  </form>
                </div>
              </div>
            </div>

            <!-- Theme toggle -->
            <button
              id="theme-toggle"
              type="button"
              class="text-neutral-500 dark:text-neutral-400 hover:bg-neutral-100 dark:hover:bg-neutral-700
                     focus:outline-none rounded-lg text-sm p-2.5">
              <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
              </svg>
              <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" clip-rule="evenodd"
                  d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707z"/>
              </svg>
            </button>
          </div>
        </div>
      </nav>
    </header>

    <!-- Panel the tabs will fill -->
    <main id="main"
          class="p-4"
          hx-get="/tabs/details"
          hx-trigger="load"
          hx-target="#main"
          hx-swap="innerHTML">
      <!-- Details tab content will load on page load -->
    </main>

    <!-- Theme toggle script -->
    <script>
    (() => {
      const btn = document.getElementById("theme-toggle");
      const moon = document.getElementById("theme-toggle-dark-icon");
      const sun  = document.getElementById("theme-toggle-light-icon");
      const logo = document.getElementById("logo-img");  // ← add

      function setIcons(isDark) {
        sun?.classList.toggle("hidden", !isDark);
        moon?.classList.toggle("hidden", isDark);
      }
      function setLogo(isDark) {                           // ← add
        if (logo) logo.src = isDark ? "/static/img/openvpn-dark.svg"
                                    : "/static/img/openvpn-light.svg";
      }

      const initialIsDark = document.documentElement.classList.contains("dark");
      setIcons(initialIsDark);
      setLogo(initialIsDark);                               // ← add

      btn?.addEventListener("click", () => {
        const isDark = !document.documentElement.classList.contains("dark");
        document.documentElement.classList.toggle("dark", isDark);
        localStorage.setItem("theme", isDark ? "dark" : "light");
        setIcons(isDark);
        setLogo(isDark);                                    // ← add
      });
    })();
    </script>

    <!-- Login popover script -->
    <script>
      (() => {
        const btn   = document.getElementById('login-toggle');
        const panel = document.getElementById('login-popover');
        const close = document.getElementById('login-close');
        if (!btn || !panel) return;

        const firstFocusable = () =>
          panel.querySelector('input, button, [href], select, textarea, [tabindex]:not([tabindex="-1"])');

        function open() {
          panel.classList.remove('hidden');
          btn.setAttribute('aria-expanded', 'true');
          document.addEventListener('click', outside, { capture: true });
          document.addEventListener('keydown', onKey);
          firstFocusable()?.focus({ preventScroll: true });
        }

        function hide() {
          if (panel.classList.contains('hidden')) return;
          panel.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false');
          document.removeEventListener('click', outside, { capture: true });
          document.removeEventListener('keydown', onKey);
          btn.focus({ preventScroll: true });
        }

        function outside(e) {
          if (panel.contains(e.target) || btn.contains(e.target)) return;
          hide();
        }

        function onKey(e) {
          if (e.key === 'Escape') { hide(); return; }
          if (e.key === 'Tab') {
            const nodes = panel.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
            if (!nodes.length) return;
            const first = nodes[0], last = nodes[nodes.length - 1];
            if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
            else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
          }
        }

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          panel.classList.contains('hidden') ? open() : hide();
        });
        close?.addEventListener('click', hide);
      })();
    </script>

    <!-- Tabs active state script -->
    <script>
      (() => {
        const tabs = document.getElementById('tabs');
        if (!tabs) return;

        const on  = ['text-blue-600','border-blue-600','active','dark:text-blue-500','dark:border-blue-500'];
        const off = ['border-transparent','hover:text-neutral-600','hover:border-neutral-300','dark:hover:text-neutral-300'];

        const tabLinks = () => tabs.querySelectorAll('a[hx-get^="/tabs/"]');

        function setActiveBySlug(slug) {
          tabLinks().forEach(a => {
            const isActive = a.getAttribute('hx-get') === `/tabs/${slug}`;
            a.setAttribute('aria-current', isActive ? 'page' : '');
            on.forEach(c => a.classList.toggle(c, isActive));
            off.forEach(c => a.classList.toggle(c, !isActive));
          });
        }

        function slugFromURL(url) {
          try {
            const p = new URL(url, location.origin).pathname;
            const m = p.match(/\/tabs\/([^/]+)/);
            return m ? m[1] : 'details'; // default matches initial tab
          } catch { return 'details'; }
        }

        setActiveBySlug(slugFromURL(location.href));

        tabs.addEventListener('click', (e) => {
          const a = e.target.closest('a[hx-get^="/tabs/"]');
          if (!a) return;
          const slug = a.getAttribute('hx-get').split('/').pop();
          setActiveBySlug(slug);
        });

        document.body.addEventListener('htmx:afterSwap', (e) => {
          if (e.target && e.target.id === 'main') {
            setActiveBySlug(slugFromURL(location.href));
          }
        });
        document.addEventListener('htmx:historyRestore', () => {
          setActiveBySlug(slugFromURL(location.href));
        });
      })();
    </script>
  </body>
</html>
